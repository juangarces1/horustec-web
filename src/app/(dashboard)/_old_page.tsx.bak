'use client';

import { useEffect, useState } from 'react';
import { useQuery } from '@tanstack/react-query';
import { monitoringApi } from '@/lib/api/monitoring';
import { monitoringHub } from '@/lib/signalr/monitoring-hub';
import { DispenserCard } from '@/components/monitor/dispenser-card';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import type { NozzleStatusDto, NozzleStatus } from '@/types/api';
import { Activity, Fuel, TrendingUp, Clock } from 'lucide-react';

interface DispenserGroup {
  dispenserNumber: number;
  nozzleCodes: string[];
  products: string[];
  status: NozzleStatus;
  currentLiters: number | null;
  activeNozzle: { code: string; product: string } | null;
}

// Product mapping based on nozzle configuration
const NOZZLE_PRODUCTS: Record<string, string> = {
  '01': 'Super',
  '02': 'Regular',
  '03': 'Diesel',
  '04': 'Super',
  '05': 'Regular',
  '06': 'Diesel',
  '07': 'Super',
  '08': 'Regular',
  '09': 'Diesel',
  '10': 'Super',
  '11': 'Regular',
  '12': 'Diesel',
  '13': 'Super',
  '14': 'Regular',
  '15': 'Diesel',
  '16': 'Super',
  '17': 'Regular',
  '18': 'Diesel',
  '19': 'Super',
  '20': 'Regular',
  '21': 'Diesel',
  '22': 'Super',
  '23': 'Regular',
  '24': 'Diesel',
  '25': 'Super',
  '26': 'Exonerado',
  '27': 'Diesel',
  '28': 'Super',
  '29': 'Exonerado',
  '30': 'Diesel',
};

export default function DashboardPage() {
  const [visualizations, setVisualizations] = useState<Map<string, number>>(new Map());
  const [lastUpdate, setLastUpdate] = useState<Date>(new Date());

  // Fetch nozzle statuses
  const { data: statuses, isLoading, error, refetch } = useQuery({
    queryKey: ['nozzle-statuses'],
    queryFn: monitoringApi.getStatuses,
    refetchInterval: 3000,
  });

  // Fetch visualizations
  useQuery({
    queryKey: ['visualizations'],
    queryFn: async () => {
      const data = await monitoringApi.getVisualization();
      const map = new Map<string, number>();
      data.forEach((v) => map.set(v.nozzleCode, v.currentLiters * 100));
      setVisualizations(map);
      setLastUpdate(new Date());
      return data;
    },
    refetchInterval: 1000,
  });

  // SignalR real-time updates
  useEffect(() => {
    monitoringHub.connect();

    monitoringHub.onStatusChanged((nozzleNumber, status, statusDescription) => {
      console.log('Status changed:', { nozzleNumber, status, statusDescription });
      refetch();
      setLastUpdate(new Date());
    });

    monitoringHub.onVisualizationUpdated((nozzleNumber, currentValue) => {
      console.log('Visualization updated:', { nozzleNumber, currentValue });
      const nozzleCode = nozzleNumber.toString().padStart(2, '0');
      setVisualizations((prev) => new Map(prev).set(nozzleCode, currentValue * 100));
      setLastUpdate(new Date());
    });

    return () => {
      monitoringHub.off('StatusChanged');
      monitoringHub.off('VisualizationUpdated');
    };
  }, [refetch]);

  // Group nozzles into dispensers (3 nozzles per dispenser)
  const groupDispensers = (nozzles: NozzleStatusDto[]): DispenserGroup[] => {
    const dispensers: DispenserGroup[] = [];

    for (let i = 0; i < 10; i++) {
      const dispenserNumber = i + 1;
      const startNozzle = i * 3;
      const dispenserNozzles = nozzles.slice(startNozzle, startNozzle + 3);

      if (dispenserNozzles.length === 0) continue;

      let dispenserStatus = dispenserNozzles[0].status;
      let activeNozzleIndex = 0;
      const statusPriority = [3, 4, 5, 7, 2, 1, 8, 6, 0];

      for (let i = 0; i < dispenserNozzles.length; i++) {
        const nozzle = dispenserNozzles[i];
        const currentPriority = statusPriority.indexOf(nozzle.status);
        const dispenserPriority = statusPriority.indexOf(dispenserStatus);
        if (currentPriority < dispenserPriority) {
          dispenserStatus = nozzle.status;
          activeNozzleIndex = i;
        }
      }

      const allSameStatus = dispenserNozzles.every(n => n.status === dispenserStatus);

      let totalLiters = 0;
      let hasLiters = false;
      for (const nozzle of dispenserNozzles) {
        const liters = visualizations.get(nozzle.nozzleCode);
        if (liters && liters > 0) {
          totalLiters += liters;
          hasLiters = true;
        }
      }

      let activeNozzle: { code: string; product: string } | null = null;
      if (!allSameStatus || dispenserStatus === 3) {
        const nozzle = dispenserNozzles[activeNozzleIndex];
        activeNozzle = {
          code: nozzle.nozzleCode,
          product: NOZZLE_PRODUCTS[nozzle.nozzleCode] || 'Unknown',
        };
      }

      dispensers.push({
        dispenserNumber,
        nozzleCodes: dispenserNozzles.map(n => n.nozzleCode),
        products: dispenserNozzles.map(n => NOZZLE_PRODUCTS[n.nozzleCode] || 'Unknown'),
        status: dispenserStatus,
        currentLiters: hasLiters ? totalLiters : null,
        activeNozzle,
      });
    }

    return dispensers;
  };

  const dispensers = statuses ? groupDispensers(statuses) : [];

  // Calculate summary metrics
  const activeDispensers = dispensers.filter(d => d.status === 3).length; // Fueling
  const availableDispensers = dispensers.filter(d => d.status === 1).length; // Available
  const totalVolume = dispensers.reduce((acc, d) => acc + (d.currentLiters || 0), 0);

  if (isLoading) {
    return (
      <div className="flex min-h-screen items-center justify-center">
        <div className="text-center">
          <div className="inline-block animate-spin rounded-full h-16 w-16 border-b-2 border-indigo-600 mb-4"></div>
          <div className="text-xl text-slate-700">Cargando dispensadores...</div>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="flex min-h-screen items-center justify-center">
        <div className="text-xl text-red-500">
          Error al cargar estados: {error instanceof Error ? error.message : 'Error desconocido'}
        </div>
      </div>
    );
  }

  return (
    <div className="p-6 lg:p-8 space-y-6">
      {/* Header */}
      <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div>
          <h1 className="text-4xl font-bold text-slate-900">Dashboard Principal</h1>
          <p className="mt-2 text-lg text-slate-600">
            Monitoreo en tiempo real de dispensadores de combustible
          </p>
        </div>
        <div className="flex gap-2">
          <Button onClick={() => refetch()} variant="outline" className="border-2">
            <Activity className="mr-2 h-4 w-4" />
            Actualizar
          </Button>
        </div>
      </div>

      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <Card className="bg-gradient-to-br from-green-50 to-emerald-50 border-green-200 shadow-md hover:shadow-lg transition-shadow">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-green-700">Abastecimientos Activos</p>
                <p className="text-3xl font-bold text-green-900 mt-2">{activeDispensers}</p>
              </div>
              <div className="h-12 w-12 rounded-full bg-green-500/20 flex items-center justify-center">
                <Fuel className="h-6 w-6 text-green-600" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="bg-gradient-to-br from-blue-50 to-indigo-50 border-blue-200 shadow-md hover:shadow-lg transition-shadow">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-blue-700">Dispensadores Disponibles</p>
                <p className="text-3xl font-bold text-blue-900 mt-2">{availableDispensers}</p>
              </div>
              <div className="h-12 w-12 rounded-full bg-blue-500/20 flex items-center justify-center">
                <Activity className="h-6 w-6 text-blue-600" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="bg-gradient-to-br from-purple-50 to-violet-50 border-purple-200 shadow-md hover:shadow-lg transition-shadow">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-purple-700">Volumen Actual</p>
                <p className="text-3xl font-bold text-purple-900 mt-2">
                  ₡{Math.round(totalVolume).toLocaleString()}
                </p>
              </div>
              <div className="h-12 w-12 rounded-full bg-purple-500/20 flex items-center justify-center">
                <TrendingUp className="h-6 w-6 text-purple-600" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="bg-gradient-to-br from-slate-50 to-gray-50 border-slate-200 shadow-md hover:shadow-lg transition-shadow">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-slate-700">Última Actualización</p>
                <p className="text-lg font-bold text-slate-900 mt-2">
                  {lastUpdate.toLocaleTimeString('es-ES')}
                </p>
              </div>
              <div className="h-12 w-12 rounded-full bg-slate-500/20 flex items-center justify-center">
                <Clock className="h-6 w-6 text-slate-600" />
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Dispensers Grid */}
      <div>
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-2xl font-bold text-slate-900">Dispensadores</h2>
          <Badge variant="outline" className="text-sm">
            {dispensers.length} Total
          </Badge>
        </div>
        <div className="grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5">
          {dispensers.map((dispenser) => (
            <DispenserCard
              key={dispenser.dispenserNumber}
              dispenserNumber={dispenser.dispenserNumber}
              status={dispenser.status}
              currentLiters={dispenser.currentLiters}
              activeNozzle={dispenser.activeNozzle}
            />
          ))}
        </div>
      </div>

      {/* Legend */}
      <Card className="shadow-md">
        <CardContent className="p-6">
          <h2 className="mb-4 text-xl font-bold text-slate-800">Leyenda de Estados</h2>
          <div className="grid grid-cols-2 gap-3 sm:grid-cols-3 md:grid-cols-5">
            <div className="flex items-center space-x-2">
              <div className="h-4 w-4 rounded bg-green-500 shadow-sm"></div>
              <span className="text-sm font-medium text-slate-700">Libre</span>
            </div>
            <div className="flex items-center space-x-2">
              <div className="h-4 w-4 rounded bg-red-500 shadow-sm"></div>
              <span className="text-sm font-medium text-slate-700">Bloqueado</span>
            </div>
            <div className="flex items-center space-x-2">
              <div className="h-4 w-4 rounded bg-orange-500 shadow-sm animate-pulse"></div>
              <span className="text-sm font-medium text-slate-700">Abasteciendo</span>
            </div>
            <div className="flex items-center space-x-2">
              <div className="h-4 w-4 rounded bg-blue-500 shadow-sm"></div>
              <span className="text-sm font-medium text-slate-700">Pronto</span>
            </div>
            <div className="flex items-center space-x-2">
              <div className="h-4 w-4 rounded bg-yellow-500 shadow-sm"></div>
              <span className="text-sm font-medium text-slate-700">Espera</span>
            </div>
            <div className="flex items-center space-x-2">
              <div className="h-4 w-4 rounded bg-red-800 shadow-sm"></div>
              <span className="text-sm font-medium text-slate-700">Falla</span>
            </div>
            <div className="flex items-center space-x-2">
              <div className="h-4 w-4 rounded bg-purple-500 shadow-sm"></div>
              <span className="text-sm font-medium text-slate-700">Ocupado</span>
            </div>
            <div className="flex items-center space-x-2">
              <div className="h-4 w-4 rounded bg-red-900 shadow-sm"></div>
              <span className="text-sm font-medium text-slate-700">Error</span>
            </div>
            <div className="flex items-center space-x-2">
              <div className="h-4 w-4 rounded bg-gray-300 shadow-sm"></div>
              <span className="text-sm font-medium text-slate-700">No Config.</span>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Info banner */}
      <Card className="bg-gradient-to-r from-indigo-500 to-purple-600 border-0 shadow-lg">
        <CardContent className="p-6 text-white">
          <div className="flex items-center gap-4">
            <div className="text-4xl">⚡</div>
            <div>
              <h3 className="text-lg font-bold">Actualización en Tiempo Real</h3>
              <p className="text-sm opacity-90 mt-1">
                Los estados y valores se actualizan automáticamente vía SignalR.
                Cada dispensador agrupa 3 mangueras y muestra el progreso total durante el abastecimiento.
              </p>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
